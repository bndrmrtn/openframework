<?php
/**
 * this may seem a bit complicated :|
 * but it's easy to use
 * run php components create ComponentName
 * and than edit the component in /serve/view/components/data/componentname/
 * you could also use a shortcut for create command like: php components c ComponentName
 * to delete a component use php components delete ComponentName
 * or the shortcut: php components d ComponentName
 */


define('CROOT',__DIR__ . '/serve/view/components');
define('CLONEDIR',__DIR__ . '/serve/view/components/clone/');
define('COMPONENTDIR',__DIR__ . '/serve/view/components/data/');

if(isset($argv[2])){
    $action = strtolower($argv[1]);
    $name = strtolower($argv[2]);
    if($action == 'create' || $action == 'c'){
        if(!is_dir(COMPONENTDIR . $name)){
            echo 'Generating component...' . "\n";
            mkdir(COMPONENTDIR . $name);
            $cloader = file_get_contents(CLONEDIR . 'load.php');
            $cloader = str_replace('_COMPONENTNAME_',ucfirst($name),$cloader);
            file_put_contents(COMPONENTDIR . $name . '/load.php',$cloader);
            $compdata = file_get_contents(CLONEDIR . 'component.php');
            file_put_contents(COMPONENTDIR . $name . '/component.php',$compdata);
            $includefile = file_get_contents(CROOT . '/components.php');
            $includefile .= "\n";
            $includefile .= "Components::create('$name','/$name');";
            $includefile .= "\n";
            file_put_contents(CROOT . '/components.php',$includefile);
            echo ucfirst($name) . ' component successfully created';
        } else {
            echo 'Component already found under "' . $name . '" name';
        }
    } 
    else if($action == 'delete' || $action == 'd'){
        if(is_dir(COMPONENTDIR . $name)){
            deleteDir(COMPONENTDIR . $name . '/');
            $configfile = file_get_contents(CROOT . '/components.php');
            $new_data = str_replace("\n\nComponents::create('{$name}','/{$name}');","",$configfile);
            file_put_contents(CROOT . '/components.php',$new_data);
            echo 'Successfully deleted';
        } else {
            echo 'The "'.$name.'" component does not exist';
        }
    } else {
        echo 'Unknow action';
    }
}

function deleteDir($dirPath) {
    if (!is_dir($dirPath)) {
        throw new InvalidArgumentException("$dirPath must be a directory");
    }
    if (substr($dirPath, strlen($dirPath) - 1, 1) != '/') {
        $dirPath .= '/';
    }
    $files = glob($dirPath . '*', GLOB_MARK);
    foreach ($files as $file) {
        if (is_dir($file)) {
            deleteDir($file);
        } else {
            unlink($file);
        }
    }
    rmdir($dirPath);
}